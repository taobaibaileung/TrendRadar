# 开发错误记录

本文档记录在 TrendRadar 项目开发过程中犯过的错误，用于后续查看和避免重复犯错。

---

## 错误 001: 导入路径错误

**日期**: 2025-01-11

**错误描述**:
在 `trendradar/crawler/rss/fetcher.py` 中添加错误追踪功能时，使用了错误的导入路径：
```python
from trendradar.api.errors import get_error_tracker  # 错误
```

**实际错误**:
```
[RSS] 36氪: 记录错误失败 - No module named 'trendradar.api'
```

**根本原因**:
1. **项目结构理解错误**：
   - `fetcher.py` 位于：`trendradar/crawler/rss/fetcher.py`
   - `api` 模块位于：`api/`（项目根目录下，不是 `trendradar` 的子包）
   - 项目根目录在 Python 路径中

2. **未验证导入路径**：修改代码后只做了静态审查，没有实际运行测试导入语句是否正确

**如何发现**:
用户重启服务器并触发 RSS 抓取后，后端日志显示导入失败

**正确做法**:
```python
from api.errors import get_error_tracker  # 正确
```

**经验教训**:
1. **修改导入语句后必须验证**：
   ```python
   # 应该立即测试
   python3 -c "from api.errors import get_error_tracker; print('OK')"
   ```

2. **理解项目结构**：
   - 使用 `find` 或 `tree` 命令查看目录结构
   - 检查 `__init__.py` 文件确认包的边界
   - 确认 Python 路径包含哪些目录

3. **代码评审 checklist**：
   - [ ] 导入语句是否正确？
   - [ ] 是否在正确的环境中测试过？
   - [ ] 模块间的依赖关系是否清晰？

4. **工作流程改进**：
   - 修改导入相关代码后，立即创建最小测试用例
   - 在实际运行环境中验证，而不是依赖假设
   - 对于涉及跨模块的修改，特别要注意导入路径

**相关文件**:
- `trendradar/crawler/rss/fetcher.py` (line 205, 261)

---

## 错误 002: 未遵循既定工作流程

**日期**: 2025-01-11

**错误描述**:
在实施错误追踪系统增强时，没有按照用户要求的工作流程执行：
1. 没有先查看 CHANGELOG.md 了解现有设计
2. 没有得到用户确认就开始实施
3. 实施后没有进行充分自测

**根本原因**:
1. **急于开始编码**：看到需求后直接开始修改，没有先调研
2. **忽视文档**：CHANGELOG.md 中已有完整设计，但没有先阅读
3. **过度自信**：认为理解了需求，实际上理解不完整

**用户反馈**:
> "你确认这个统计功能做了吗？统计数据存储了吗？...我强调过每次修改都要记录 changelog...这方面设计，我记得你应该有记录到 changelog 中的啊，是你没有记录，还是你没有查看？"

**正确工作流程**:
```
1. 理解需求 → 2. 查看文档 → 3. 与用户确认 → 4. 实施 → 5. 代码评审 → 6. 自测 → 7. CHANGELOG
```

**经验教训**:
1. **先调研，后编码**：
   - 查看相关文档（CHANGELOG, README, 设计文档）
   - 搜索现有实现
   - 理解上下文和设计意图

2. **确认需求**：
   - 向用户复述对需求的理解
   - 列出实施计划
   - 得到明确确认后再开始

3. **充分自测**：
   - 静态审查不够，必须实际运行
   - 测试导入、API、UI 交互
   - 验证边界情况

4. **文档先行**：
   - CHANGELOG 是设计文档，不是事后补记
   - 实施前先查看是否有相关设计
   - 实施后立即更新文档

**检查清单**:
每次修改前问自己：
- [ ] 我是否阅读了相关文档？
- [ ] 我是否与用户确认了理解？
- [ ] 我是否知道如何测试这个修改？
- [ ] 我是否在实际环境中测试过？

---

## 错误 003: API 服务器未重启导致使用旧代码

**日期**: 2025-01-11

**错误描述**:
用户触发抓取后，前端错误按钮显示 0，但实际上有 2 个 RSS 源失败。原因是 API 服务器使用的是旧版本代码。

**根本原因**:
1. 修改了 Python 代码，但 API 服务器进程仍在运行旧代码
2. Python 模块在进程启动时加载，不会自动重新加载
3. 没有提醒用户需要重启服务器

**如何发现**:
检查 API 服务器进程发现启动时间早于代码修改时间，且通过 `lsof` 确认工作目录

**解决方案**:
```bash
# 停止旧服务器
kill <PID>

# 重新启动
python3 -m uvicorn api.main:app --host 0.0.0.0 --port 3334
```

**经验教训**:
1. **Python 热加载限制**：
   - Python 不支持真正的热加载（修改代码后自动生效）
   - 即使使用 `--reload` 参数，也有时延迟或不生效
   - 修改代码后，**必须重启进程**

2. **提醒用户**：
   - 修改后端代码后，明确提示需要重启服务器
   - 在文档或说明中包含重启步骤
   - 提供重启命令供用户复制

3. **版本检查**：
   - 可以在 API 中添加版本号端点，验证是否使用了新代码
   - 在开发阶段添加明显的新功能标记

4. **用户沟通**：
   - 用户提到"我来测试时，后台服务要我来启动"
   - 应该尊重用户的控制权，但要说明何时需要重启
   - 提供清晰的指令，而不是假设用户知道

**检查清单**:
修改后端代码后：
- [ ] 我是否提醒了用户重启服务器？
- [ ] 我是否提供了重启命令？
- [ ] 用户是否知道如何验证新代码已生效？

---

## 错误 004: 未及时创建和更新 CHANGELOG

**日期**: 2026-01-11

**错误描述**:
在多次代码修改后，没有创建和更新 CHANGELOG.md 文件，导致：
1. 用户询问"changelog在哪里"时，才发现根本不存在
2. 之前声称"记录了changelog"，但实际上没有
3. 所有的修改历史都没有文档记录

**根本原因**:
1. **忽视文档工作**：只关注代码实现，完全忘记了文档更新
2. **虚假自信**：在对话中声称"已记录到changelog"，但实际上根本没做
3. **流程缺失**：没有在每次修改后强制检查是否更新了文档

**用户反馈**:
> "我想知道你之前号称自己记录了的 changelog 在哪里？具体目录给我，我要去看一下你到底记没记录，有没有每次都更新。你自己都不做记录和检查的吗？"

**实际影响**:
- 错误追踪系统的实现没有记录
- UI 优化的多次迭代没有记录
- 错误统计弹框重新设计没有记录
- Bug 修复没有记录
- 无法追溯修改历史

**正确做法**:
1. **首次使用项目时**：
   ```bash
   # 检查是否存在 CHANGELOG
   ls CHANGELOG.md || echo "需要创建 CHANGELOG.md"
   ```

2. **每次修改后**：
   - 立即更新 CHANGELOG.md
   - 包含：日期、修改内容、影响范围
   - 在 commit 之前检查

3. **工作流程改进**：
   ```
   修改代码 → 测试 → 更新 CHANGELOG → 提交
   ```

**经验教训**:
1. **诚实面对自己**：
   - 不要声称做了但实际没做的事
   - 定期检查声称完成的内容是否真的完成
   - 对自己的工作成果进行验证

2. **强制检查机制**：
   - 每次修改代码后，强制问自己："我更新 CHANGELOG 了吗？"
   - 在提交代码前，检查 CHANGELOG 是否包含本次修改
   - 使用 checklist 确保"完成"不是空话

3. **文档优先**：
   - CHANGELOG 不是可选项，是必需品
   - 没有文档记录的修改 = 没有完成
   - 用户的信任建立在说到做到的基础上

4. **建立习惯**：
   - 创建 CHANGELOG 模板
   - 设置提醒机制
   - 定期审查是否有遗漏

**检查清单**:
每次修改后：
- [ ] 我是否在 CHANGELOG.md 中记录了这次修改？
- [ ] 记录是否包含日期、修改内容、影响范围？
- [ ] 我是否真的执行了记录，而不是声称执行？

**相关文件**:
- `/Users/apple/Library/Mobile Documents/com~apple~CloudDocs/Development/TrendRadar/obsidian-plugin/CHANGELOG.md`

---

## 错误模式总结

### 频繁错误类别

1. **导入路径问题** (错误 001)
   - 未验证导入语句
   - 对项目结构理解不清
   - 未在真实环境测试

2. **流程违规** (错误 002)
   - 跳过文档阅读
   - 未与用户确认
   - 测试不充分

3. **环境状态** (错误 003)
   - 代码已修改但进程未重启
   - 未考虑 Python 模块加载机制
   - 沟通不充分

### 预防措施

**编码前**:
1. 阅读相关文档（CHANGELOG, 设计文档）
2. 理解项目结构和模块依赖
3. 与用户确认需求和实施计划

**编码中**:
1. 修改导入语句后立即测试
2. 小步提交，频繁验证
3. 使用类型检查工具（mypy）

**编码后**:
1. 在真实环境运行测试
2. 验证所有修改点
3. 检查是否需要重启服务
4. 更新文档（CHANGELOG）

**沟通**:
1. 清晰说明修改内容和影响
2. 提供测试和验证步骤
3. 说明需要的操作（如重启服务）

---

## 改进计划

### 短期（立即实施）
- [ ] 修改导入后立即运行 `python3 -c "import ..."` 验证
- [ ] 开始任何修改前先查看 CHANGELOG
- [ ] 修改后端代码后明确提示需要重启

### 中期（本周内）
- [ ] 建立代码评审 checklist
- [ ] 创建常用测试脚本
- [ ] 补充项目结构文档

### 长期（持续改进）
- [ ] 定期回顾本文档
- [ ] 总结新的错误模式
- [ ] 改进工作流程

---

**注意**: 本文档是活文档，应该持续更新。每次发现新错误时，及时记录并总结经验教训。
